<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kyzo Code Sharing - Professional Code Repository</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00ff88;
            --primary-dark: #00cc6a;
            --secondary: #7000ff;
            --accent: #ff3366;
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-hover: #1a1a24;
            --border: #2a2a35;
            --text: #ffffff;
            --text-dim: #a0a0b0;
            --success: #00ff88;
            --error: #ff3366;
            --warning: #ffaa00;
        }

        body {
            font-family: 'Inter', 'Courier New', monospace;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(112, 0, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 255, 136, 0.05) 0%, transparent 20%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Glassmorphism Effect */
        .glass {
            background: rgba(18, 18, 26, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            gap: 12px;
        }

        .logo {
            font-size: 18px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .logo span {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            font-family: 'Inter', monospace;
            font-size: 13px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--bg-dark);
            border: none;
            font-weight: 600;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: rgba(0, 255, 136, 0.1);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .btn-danger:hover {
            background: var(--error);
            color: white;
        }

        /* Kategori */
        .categories {
            margin-top: 80px;
            display: flex;
            gap: 12px;
            padding: 20px 5px;
            flex-wrap: nowrap;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--bg-card);
        }

        .categories::-webkit-scrollbar {
            height: 4px;
        }

        .categories::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 10px;
        }

        .categories::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .category-tab {
            background: var(--bg-card);
            color: var(--text-dim);
            border: 1px solid var(--border);
            padding: 10px 24px;
            cursor: pointer;
            font-family: 'Inter', monospace;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-radius: 30px;
            flex-shrink: 0;
            letter-spacing: 0.3px;
        }

        .category-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .category-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--bg-dark);
            border: none;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        /* Auto Refresh Controls */
        .refresh-status {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 5px;
            padding: 15px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 13px;
            backdrop-filter: blur(10px);
        }

        .refresh-toggle {
            background: var(--bg-dark);
            color: var(--text-dim);
            border: 1px solid var(--border);
            padding: 6px 14px;
            cursor: pointer;
            font-family: 'Inter', monospace;
            font-size: 12px;
            font-weight: 500;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .refresh-toggle.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--bg-dark);
            border: none;
            font-weight: 600;
        }

        .refresh-timer {
            color: var(--text-dim);
            font-size: 12px;
        }

        .refresh-count {
            color: var(--primary);
            margin-left: auto;
            font-weight: 500;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            padding: 20px;
            display: none;
            overflow-y: auto;
        }

        .modal-content {
            max-width: 600px;
            margin: 40px auto;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 30px;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            font-size: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-modal {
            background: var(--bg-dark);
            color: var(--text-dim);
            border: 1px solid var(--border);
            padding: 8px 20px;
            cursor: pointer;
            font-family: 'Inter', monospace;
            border-radius: 30px;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            border-color: var(--error);
            color: var(--error);
        }

        /* Forms */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-dim);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Inter', monospace;
            font-size: 14px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group small {
            display: block;
            margin-top: 8px;
            color: var(--text-dim);
            font-size: 12px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            accent-color: var(--primary);
        }

        /* Request List */
        .request-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .request-item {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .request-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.1);
        }

        .request-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .request-preview {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            background: var(--bg-card);
        }

        .request-info {
            margin-bottom: 15px;
        }

        .request-info p {
            margin: 8px 0;
            color: var(--text-dim);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .request-info strong {
            color: var(--text);
            min-width: 70px;
        }

        .request-type {
            display: inline-block;
            background: rgba(0, 255, 136, 0.1);
            color: var(--primary);
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 30px;
            letter-spacing: 0.5px;
        }

        .request-time {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .no-foto {
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            font-size: 13px;
            gap: 8px;
        }

        /* Code Drawers */
        .code-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 10px 5px;
        }

        .code-drawer {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .code-drawer::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), transparent);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .code-drawer:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.15);
        }

        .code-drawer:hover::after {
            transform: translateX(0);
        }

        .code-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 8px;
        }

        .code-desc {
            font-size: 13px;
            color: var(--text-dim);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .code-stats {
            display: flex;
            gap: 15px;
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 10px;
        }

        .code-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Code Display */
        .code-display {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            backdrop-filter: blur(10px);
            z-index: 1001;
            padding: 20px;
            display: none;
            overflow-y: auto;
        }

        .code-header {
            position: sticky;
            top: 0;
            background: var(--bg-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            border: 1px solid var(--border);
            border-radius: 12px;
            z-index: 10;
        }

        .code-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            overflow-x: auto;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--text);
            word-break: break-all;
        }

        /* Loading & Messages */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-dim);
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .message {
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 12px;
            display: none;
            font-size: 14px;
            font-weight: 500;
        }

        .success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .error {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .warning {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 13px;
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .code-list {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .code-content {
                font-size: 12px;
                padding: 15px;
            }
            
            .category-tab {
                padding: 8px 18px;
                font-size: 13px;
            }

            .request-list {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 20px;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .code-list {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .code-name {
                font-size: 13px;
            }
            
            .code-desc {
                font-size: 11px;
            }
            
            .refresh-status {
                flex-wrap: wrap;
            }

            .header-left {
                gap: 6px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 11px;
            }

            .logo {
                font-size: 14px;
            }
        }

        /* Utility Classes */
        .text-gradient {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 30px;
            font-size: 11px;
            color: var(--text-dim);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="btn btn-primary" onclick="openAdminPanel()">
                <span>üëë</span> ADMIN
            </button>
            <button class="btn btn-outline" onclick="openRequestModal()">
                <span>üìù</span> REQUEST
            </button>
        </div>
        <div class="logo">KYZO<span>CODE</span></div>
    </div>

    <div class="container">
        <!-- Kategori -->
        <div class="categories">
            <button class="category-tab active" onclick="selectCategory('esm')">üì¶ Plugin ESM</button>
            <button class="category-tab" onclick="selectCategory('cjs')">üì¶ Plugin CJS</button>
            <button class="category-tab" onclick="selectCategory('case')">üìÅ Case</button>
        </div>

        <!-- Auto Refresh Controls -->
        <div class="refresh-status" id="refreshStatus">
            <span>üîÑ Auto Refresh:</span>
            <button class="refresh-toggle" id="refreshToggle" onclick="toggleAutoRefresh()">OFF</button>
            <span class="refresh-timer" id="refreshTimer">Next: 30s</span>
            <span class="refresh-count" id="refreshCount">Last: --:--</span>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid" id="statsOverview">
            <div class="stat-card">
                <div class="stat-value" id="statESM">0</div>
                <div class="stat-label">ESM Plugins</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statCJS">0</div>
                <div class="stat-label">CJS Plugins</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statCase">0</div>
                <div class="stat-label">Cases</div>
            </div>
        </div>

        <!-- Code List -->
        <div class="code-list" id="codeList">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span>Memuat kode...</span>
            </div>
        </div>
    </div>

    <!-- Request Modal -->
    <div class="modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Buat Request Baru</h2>
                <button class="close-modal" onclick="closeRequestModal()">TUTUP</button>
            </div>
            
            <div class="form-group">
                <label>Nama Kamu <span class="badge">Wajib</span></label>
                <input type="text" id="requestName" placeholder="Contoh: Muhammad Rizki">
            </div>
            <div class="form-group">
                <label>Fitur yang Diminta <span class="badge">Wajib</span></label>
                <textarea id="requestFitur" placeholder="Jelaskan fitur yang kamu inginkan secara detail..."></textarea>
            </div>
            <div class="form-group">
                <label>URL Foto/Contoh <span class="badge">Opsional</span></label>
                <input type="url" id="requestFoto" placeholder="https://example.com/image.jpg">
                <small>Kosongkan jika tidak ada foto contoh</small>
            </div>
            <div class="form-group">
                <label>Tipe Kode <span class="badge">Wajib</span></label>
                <select id="requestType">
                    <option value="esm">ESM Plugin</option>
                    <option value="cjs">CJS Plugin</option>
                    <option value="case">Case</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="submitRequest()">
                <span>üì®</span> KIRIM REQUEST
            </button>
            <div class="message" id="requestMessage"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="modal" id="adminPanel">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üëë Admin Panel</h2>
                <button class="close-modal" onclick="closeAdminPanel()">TUTUP</button>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label>Password Admin</label>
                    <input type="password" id="adminPassword" placeholder="Masukkan password">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="loginAdmin()">LOGIN</button>
                <div class="message" id="loginMessage"></div>
            </div>
            
            <!-- Upload Form (Hidden by default) -->
            <div id="uploadForm" style="display: none;">
                <h3 style="margin-bottom: 20px; color: var(--text);">üì§ Upload Kode Baru</h3>
                
                <div class="form-group">
                    <label>Nama Kode</label>
                    <input type="text" id="codeName" placeholder="Contoh: request.js">
                </div>
                <div class="form-group">
                    <label>Deskripsi</label>
                    <textarea id="codeDescription" placeholder="Deskripsi singkat tentang kode ini"></textarea>
                </div>
                <div class="form-group">
                    <label>Tipe Kode</label>
                    <select id="codeType">
                        <option value="esm">ESM Plugin</option>
                        <option value="cjs">CJS Plugin</option>
                        <option value="case">Case</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>File Kode (JavaScript)</label>
                    <input type="file" id="codeFile" accept=".js">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="uploadRefreshCheckbox" checked>
                    <label for="uploadRefreshCheckbox">Auto refresh setelah upload (5 detik)</label>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 30px;" onclick="uploadCode()">
                    <span>‚¨ÜÔ∏è</span> UPLOAD KODE
                </button>
                <div class="message" id="uploadMessage"></div>

                <hr style="border-color: var(--border); margin: 30px 0;">

                <!-- Request List for Admin -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: var(--text);">üìã Daftar Request</h3>
                    <button class="btn btn-outline" onclick="loadRequests()">
                        <span>üîÑ</span> Refresh
                    </button>
                </div>
                <div id="requestList" class="request-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Memuat request...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Code Display -->
    <div class="code-display" id="codeDisplay">
        <div class="code-header">
            <div>
                <button class="btn btn-outline" onclick="closeCodeDisplay()">
                    <span>‚Üê</span> KEMBALI
                </button>
            </div>
            <div>
                <button class="btn btn-primary" onclick="copyCode()" id="copyBtn">
                    <span>üìã</span> SALIN KODE
                </button>
            </div>
        </div>
        <pre class="code-content" id="codeContent"></pre>
    </div>

    <!-- Load setting.js -->
    <script src="setting.js"></script>
    
    <script>
        // State
        let currentCategory = 'esm';
        let isAdminLoggedIn = false;
        let codesCache = {
            esm: null,
            cjs: null,
            case: null
        };
        
        // Auto Refresh State
        let autoRefreshInterval = null;
        let autoRefreshEnabled = false;
        let autoRefreshTime = 30;
        let refreshTimer = autoRefreshTime;
        let uploadAutoRefresh = true;
        let refreshCount = 0;
        let lastRefreshTime = null;

        // Request State
        let requests = [];
        let requestInterval = null;

        // Cek apakah setting.js sudah dimuat
        if (typeof window.APP_CONFIG === 'undefined') {
            console.error('Error: setting.js tidak ditemukan atau tidak valid');
            alert('Error: File konfigurasi tidak ditemukan. Pastikan setting.js ada di server.');
        }

        // Elemen DOM
        const adminPanel = document.getElementById('adminPanel');
        const loginForm = document.getElementById('loginForm');
        const uploadForm = document.getElementById('uploadForm');
        const codeList = document.getElementById('codeList');
        const loading = document.getElementById('loading');
        const codeDisplay = document.getElementById('codeDisplay');
        const codeContent = document.getElementById('codeContent');
        const refreshToggle = document.getElementById('refreshToggle');
        const refreshTimerEl = document.getElementById('refreshTimer');
        const refreshCountEl = document.getElementById('refreshCount');
        const requestModal = document.getElementById('requestModal');
        const requestList = document.getElementById('requestList');
        const statESM = document.getElementById('statESM');
        const statCJS = document.getElementById('statCJS');
        const statCase = document.getElementById('statCase');

        // Fungsi untuk menampilkan pesan
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // Fungsi untuk update refresh timer display
        function updateRefreshTimer() {
            if (autoRefreshEnabled) {
                refreshTimerEl.textContent = `Next: ${refreshTimer}s`;
            } else {
                refreshTimerEl.textContent = `Next: --`;
            }
            
            if (lastRefreshTime) {
                const now = new Date();
                const diff = Math.floor((now - lastRefreshTime) / 1000);
                refreshCountEl.textContent = `Last: ${diff}s ago`;
            }
        }

        // Fungsi untuk toggle auto refresh
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            
            if (autoRefreshEnabled) {
                refreshToggle.textContent = 'ON';
                refreshToggle.classList.add('active');
                startAutoRefresh();
            } else {
                refreshToggle.textContent = 'OFF';
                refreshToggle.classList.remove('active');
                stopAutoRefresh();
            }
            
            updateRefreshTimer();
        }

        // Fungsi untuk start auto refresh
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            refreshTimer = autoRefreshTime;
            
            autoRefreshInterval = setInterval(() => {
                refreshTimer--;
                updateRefreshTimer();
                
                if (refreshTimer <= 0) {
                    refreshCodes();
                    refreshTimer = autoRefreshTime;
                }
            }, 1000);
        }

        // Fungsi untuk stop auto refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            refreshTimer = autoRefreshTime;
            updateRefreshTimer();
        }

        // Fungsi untuk refresh kode
        function refreshCodes() {
            console.log('Auto-refreshing codes...');
            refreshCount++;
            lastRefreshTime = new Date();
            loadCodes(currentCategory, true);
        }

        // Fungsi untuk memilih kategori
        function selectCategory(category) {
            // Update tab aktif
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load kode
            loadCodes(category);
        }

        // Fungsi untuk update stats
        async function updateStats() {
            try {
                // Load semua kategori untuk update stats
                const categories = ['esm', 'cjs', 'case'];
                
                for (const category of categories) {
                    if (!codesCache[category]) {
                        const repoName = window.APP_CONFIG.REPOSITORIES[category];
                        const url = `https://api.github.com/repos/${window.APP_CONFIG.GITHUB_USER}/${repoName}/contents/`;
                        
                        const response = await fetch(url, {
                            headers: {
                                'Authorization': `token ${window.APP_CONFIG.GITHUB_TOKEN}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (response.ok) {
                            const files = await response.json();
                            const codeFiles = files.filter(file => 
                                file.name.toLowerCase().endsWith('.js') && file.type === 'file'
                            );
                            codesCache[category] = codeFiles;
                        }
                    }
                }
                
                // Update stats display
                statESM.textContent = codesCache.esm ? codesCache.esm.length : 0;
                statCJS.textContent = codesCache.cjs ? codesCache.cjs.length : 0;
                statCase.textContent = codesCache.case ? codesCache.case.length : 0;
                
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Fungsi untuk request modal
        function openRequestModal() {
            requestModal.style.display = 'block';
        }

        function closeRequestModal() {
            requestModal.style.display = 'none';
            // Reset form
            document.getElementById('requestName').value = '';
            document.getElementById('requestFitur').value = '';
            document.getElementById('requestFoto').value = '';
            document.getElementById('requestType').value = 'esm';
        }

        // Fungsi untuk submit request - PASTI TIDAK NIMPA
        async function submitRequest() {
            const name = document.getElementById('requestName').value.trim();
            const fitur = document.getElementById('requestFitur').value.trim();
            const foto = document.getElementById('requestFoto').value.trim();
            const type = document.getElementById('requestType').value;

            // Validasi (foto opsional)
            if (!name || !fitur || !type) {
                showMessage('requestMessage', 'Nama, fitur, dan tipe harus diisi!', 'error');
                return;
            }

            // Validasi URL foto jika diisi
            if (foto) {
                try {
                    new URL(foto);
                } catch {
                    showMessage('requestMessage', 'URL foto tidak valid!', 'error');
                    return;
                }
            }

            const requestData = {
                nama: name,
                fitur: fitur,
                foto: foto || '',
                type: type,
                timestamp: new Date().toISOString()
            };

            try {
                // 1. Baca data existing
                let existingRequests = [];
                try {
                    const response = await fetch('https://raw.githubusercontent.com/codexsharing/request/refs/heads/main/request.json');
                    if (response.ok) {
                        const text = await response.text();
                        if (text && text.trim()) {
                            existingRequests = JSON.parse(text);
                            // Pastikan existingRequests adalah array
                            if (!Array.isArray(existingRequests)) {
                                existingRequests = [];
                            }
                        }
                    }
                } catch (e) {
                    console.log('File belum ada atau error, akan buat baru');
                    existingRequests = [];
                }

                // 2. Tambah data baru ke array (APPEND, BUKAN REPLACE)
                existingRequests.push(requestData);
                
                // 3. Simpan ke GitHub
                const apiUrl = 'https://api.github.com/repos/codexsharing/request/contents/request.json';
                
                // Cek SHA file
                let sha = null;
                try {
                    const checkResponse = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `token ${window.APP_CONFIG.GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const existingFile = await checkResponse.json();
                        sha = existingFile.sha;
                    }
                } catch (e) {
                    console.log('File belum ada');
                }

                // Encode content
                const jsonString = JSON.stringify(existingRequests, null, 2);
                const contentBase64 = btoa(unescape(encodeURIComponent(jsonString)));

                // Data untuk upload
                const data = {
                    message: `Add request from ${name} at ${new Date().toLocaleString()}`,
                    content: contentBase64,
                    branch: 'main'
                };

                if (sha) {
                    data.sha = sha;
                }

                // Upload ke GitHub
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${window.APP_CONFIG.GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Gagal mengirim request');
                }

                showMessage('requestMessage', '‚úÖ Request berhasil dikirim!', 'success');
                
                // Reset form dan tutup modal setelah 2 detik
                setTimeout(() => {
                    closeRequestModal();
                }, 2000);

            } catch (error) {
                console.error('Request error:', error);
                showMessage('requestMessage', `‚ùå Gagal mengirim request: ${error.message}`, 'error');
            }
        }

        // Fungsi untuk load requests
        async function loadRequests() {
            requestList.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Memuat request...</span>
                </div>
            `;
            
            try {
                const response = await fetch('https://raw.githubusercontent.com/codexsharing/request/refs/heads/main/request.json');
                
                if (!response.ok) {
                    throw new Error('Gagal memuat request');
                }
                
                const text = await response.text();
                
                // Parse JSON
                if (text && text.trim()) {
                    try {
                        requests = JSON.parse(text);
                    } catch (e) {
                        console.error('Error parsing JSON:', e);
                        requests = [];
                    }
                } else {
                    requests = [];
                }
                
                // Pastikan requests adalah array
                if (!Array.isArray(requests)) {
                    requests = [];
                }
                
                console.log('Loaded requests:', requests); // Debug log
                renderRequests();
                
            } catch (error) {
                console.error('Error loading requests:', error);
                requestList.innerHTML = '<div style="color: var(--error); text-align: center; padding: 40px;">‚ùå Gagal memuat request</div>';
            }
        }

        // Fungsi untuk render requests
        function renderRequests() {
            if (!requests || requests.length === 0) {
                requestList.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 40px;">üì≠ Belum ada request</div>';
                return;
            }

            // Urutkan dari yang terbaru
            requests.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));

            requestList.innerHTML = requests.map((req, index) => `
                <div class="request-item">
                    ${req.foto ? 
                        `<img src="${req.foto}" class="request-preview" alt="Preview" onerror="this.src='https://via.placeholder.com/400x200/1a1a24/00ff88?text=Gambar+Error'">` : 
                        `<div class="request-preview no-foto"><span>üì∑</span> Tidak ada foto</div>`
                    }
                    <div class="request-info">
                        <p><strong>Nama:</strong> ${req.nama || '-'}</p>
                        <p><strong>Fitur:</strong> ${req.fitur || '-'}</p>
                        ${req.foto ? `<p><strong>Foto:</strong> <a href="${req.foto}" target="_blank" style="color: var(--primary);">Lihat</a></p>` : ''}
                        <p><strong>Tipe:</strong> <span class="request-type">${(req.type || 'esm').toUpperCase()}</span></p>
                    </div>
                    <div class="request-time">
                        üìÖ ${req.timestamp ? new Date(req.timestamp).toLocaleString('id-ID', {
                            day: '2-digit',
                            month: 'long',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : '-'}
                    </div>
                    <button class="btn btn-danger" style="width: 100%; margin-top: 15px;" onclick="deleteRequest(${index})">
                        <span>üóëÔ∏è</span> HAPUS REQUEST
                    </button>
                </div>
            `).join('');
        }

        // Fungsi untuk delete request
        async function deleteRequest(index) {
            if (!confirm('Yakin ingin menghapus request ini?')) {
                return;
            }

            try {
                // Hapus request dari array
                requests.splice(index, 1);

                // Upload ke GitHub
                const apiUrl = 'https://api.github.com/repos/codexsharing/request/contents/request.json';
                
                // Cek SHA file
                const checkResponse = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `token ${window.APP_CONFIG.GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!checkResponse.ok) {
                    throw new Error('Gagal mengakses file request');
                }
                
                const existingFile = await checkResponse.json();
                const sha = existingFile.sha;

                // Encode content
                const jsonString = JSON.stringify(requests, null, 2);
                const contentBase64 = btoa(unescape(encodeURIComponent(jsonString)));

                // Data untuk upload
                const data = {
                    message: `Delete request at ${new Date().toLocaleString()}`,
                    content: contentBase64,
                    sha: sha,
                    branch: 'main'
                };

                // Upload ke GitHub
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${window.APP_CONFIG.GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Gagal menghapus request');
                }

                // Reload requests
                await loadRequests();
                
            } catch (error) {
                console.error('Delete error:', error);
                alert('Gagal menghapus request: ' + error.message);
            }
        }

        // Fungsi untuk admin panel
        function openAdminPanel() {
            adminPanel.style.display = 'block';
            if (!isAdminLoggedIn) {
                loginForm.style.display = 'block';
                uploadForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                uploadForm.style.display = 'block';
                loadRequests();
                
                // Start auto refresh requests (interval 10 detik)
                if (requestInterval) {
                    clearInterval(requestInterval);
                }
                requestInterval = setInterval(loadRequests, 10000);
            }
        }

        function closeAdminPanel() {
            adminPanel.style.display = 'none';
            // Stop auto refresh requests
            if (requestInterval) {
                clearInterval(requestInterval);
                requestInterval = null;
            }
        }

        function loginAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === window.APP_CONFIG.ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                loginForm.style.display = 'none';
                uploadForm.style.display = 'block';
                showMessage('loginMessage', '‚úÖ Login berhasil!', 'success');
                loadRequests();
                
                // Start auto refresh requests
                if (requestInterval) {
                    clearInterval(requestInterval);
                }
                requestInterval = setInterval(loadRequests, 10000);
            } else {
                showMessage('loginMessage', '‚ùå Password salah!', 'error');
            }
        }

        // Fungsi untuk memuat kode dari GitHub
        async function loadCodes(category, forceRefresh = false) {
            currentCategory = category;
            
            // Tampilkan loading
            loading.style.display = 'flex';
            codeList.innerHTML = '';
            codeList.appendChild(loading);
            
            // Jika force refresh, clear cache
            if (forceRefresh) {
                codesCache[category] = null;
            }
            
            // Cek cache
            if (codesCache[category] && !forceRefresh) {
                renderCodes(codesCache[category]);
                updateStats();
                return;
            }
            
            try {
                const repoName = window.APP_CONFIG.REPOSITORIES[category];
                const url = `https://api.github.com/repos/${window.APP_CONFIG.GITHUB_USER}/${repoName}/contents/`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${window.APP_CONFIG.GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const files = await response.json();
                
                // Filter hanya file JavaScript
                const codeFiles = files.filter(file => 
                    file.name.toLowerCase().endsWith('.js') && file.type === 'file'
                );
                
                // Simpan ke cache
                codesCache[category] = codeFiles;
                
                renderCodes(codeFiles);
                
                // Update stats
                updateStats();
                
                // Update last refresh time
                lastRefreshTime = new Date();
                updateRefreshTimer();
                
            } catch (error) {
                console.error('Error loading codes:', error);
                loading.style.display = 'none';
                codeList.innerHTML = `
                    <div style="color: var(--error); text-align: center; padding: 40px; grid-column: 1 / -1;">
                        ‚ùå Gagal memuat kode: ${error.message}
                    </div>
                `;
            }
        }

        function renderCodes(files) {
            loading.style.display = 'none';
            codeList.innerHTML = '';
            
            if (files.length === 0) {
                codeList.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 40px; grid-column: 1 / -1;">üì≠ Tidak ada kode tersedia.</div>';
                return;
            }
            
            files.forEach(file => {
                const drawer = document.createElement('div');
                drawer.className = 'code-drawer';
                
                // Simpan data file di dataset
                drawer.dataset.name = file.name;
                drawer.dataset.url = file.download_url;
                drawer.dataset.size = file.size;
                drawer.dataset.path = file.path;
                
                drawer.onclick = () => showCode(file.name, file.download_url);
                
                const name = document.createElement('div');
                name.className = 'code-name';
                name.textContent = file.name;
                
                const size = (file.size / 1024).toFixed(1);
                const desc = document.createElement('div');
                desc.className = 'code-desc';
                desc.textContent = `${size} KB`;
                
                drawer.appendChild(name);
                drawer.appendChild(desc);
                codeList.appendChild(drawer);
            });
        }

        // Fungsi untuk menampilkan kode
        async function showCode(fileName, downloadUrl) {
            try {
                codeContent.textContent = 'Memuat kode...';
                codeDisplay.style.display = 'block';
                
                // Method 1: Langsung dari GitHub raw content
                const rawUrl = downloadUrl.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
                
                const response = await fetch(rawUrl, {
                    headers: {
                        'Authorization': `token ${window.APP_CONFIG.GITHUB_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const code = await response.text();
                codeContent.textContent = code;
                
            } catch (error) {
                console.error('Error loading code:', error);
                
                // Fallback: Coba menggunakan GitHub API dengan raw format
                try {
                    const repoName = window.APP_CONFIG.REPOSITORIES[currentCategory];
                    const apiUrl = `https://api.github.com/repos/${window.APP_CONFIG.GITHUB_USER}/${repoName}/contents/${encodeURIComponent(fileName)}`;
                    
                    const apiResponse = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `token ${window.APP_CONFIG.GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3.raw'
                        }
                    });
                    
                    if (!apiResponse.ok) {
                        throw new Error(`API fallback failed: ${apiResponse.status}`);
                    }
                    
                    const code = await apiResponse.text();
                    codeContent.textContent = code;
                    
                } catch (apiError) {
                    console.error('API fallback failed:', apiError);
                    
                    codeContent.textContent = `Gagal memuat kode.\n\nError: ${error.message}`;
                }
            }
        }

        // Fungsi untuk menutup code display
        function closeCodeDisplay() {
            codeDisplay.style.display = 'none';
        }

        // Fungsi untuk menyalin kode
        async function copyCode() {
            const copyBtn = document.getElementById('copyBtn');
            const originalText = copyBtn.innerHTML;
            
            try {
                const code = codeContent.textContent;
                await navigator.clipboard.writeText(code);
                
                // Tampilkan feedback di tombol
                copyBtn.innerHTML = '<span>‚úÖ</span> TERSALIN!';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
                
            } catch (err) {
                console.error('Gagal menyalin:', err);
                
                // Fallback untuk browser lama
                const textArea = document.createElement('textarea');
                textArea.value = codeContent.textContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                copyBtn.innerHTML = '<span>‚úÖ</span> TERSALIN!';
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 1000);
            }
        }

        // Fungsi untuk upload kode
        async function uploadCode() {
            const codeName = document.getElementById('codeName').value.trim();
            const codeDesc = document.getElementById('codeDescription').value.trim();
            const codeType = document.getElementById('codeType').value;
            const fileInput = document.getElementById('codeFile');
            const autoRefreshAfterUpload = document.getElementById('uploadRefreshCheckbox').checked;
            
            // Validasi
            if (!codeName || !fileInput.files.length) {
                showMessage('uploadMessage', 'Nama kode dan file harus diisi!', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.toLowerCase().endsWith('.js')) {
                showMessage('uploadMessage', 'File harus berekstensi .js!', 'error');
                return;
            }
            
            try {
                // Baca file
                const fileContent = await readFileAsText(file);
                
                // Konfigurasi upload GitHub
                const repoName = window.APP_CONFIG.REPOSITORIES[codeType];
                const apiUrl = `https://api.github.com/repos/${window.APP_CONFIG.GITHUB_USER}/${repoName}/contents/${codeName}`;
                
                // Cek apakah file sudah ada
                let sha = null;
                try {
                    const checkResponse = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `token ${window.APP_CONFIG.GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const existingFile = await checkResponse.json();
                        sha = existingFile.sha;
                    }
                } catch (e) {
                    // File belum ada, lanjutkan
                }
                
                // Encode content ke base64
                const contentBase64 = btoa(unescape(encodeURIComponent(fileContent)));
                
                // Data untuk upload
                const data = {
                    message: `Add ${codeName} via Kyzo Code Sharing at ${new Date().toLocaleString()}`,
                    content: contentBase64,
                    branch: 'main'
                };
                
                if (sha) {
                    data.sha = sha; // Untuk update file yang sudah ada
                }
                
                // Upload ke GitHub
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${window.APP_CONFIG.GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Upload gagal: ${response.status}`);
                }
                
                // Reset form
                document.getElementById('codeName').value = '';
                document.getElementById('codeDescription').value = '';
                document.getElementById('codeFile').value = '';
                
                // Tampilkan pesan sukses
                showMessage('uploadMessage', '‚úÖ Kode berhasil diupload!', 'success');
                
                // Clear cache untuk kategori yang diupdate
                codesCache[codeType] = null;
                
                // Jika sedang melihat kategori yang diupdate, refresh
                if (currentCategory === codeType) {
                    // Jika auto refresh setelah upload diaktifkan
                    if (autoRefreshAfterUpload) {
                        setTimeout(() => {
                            loadCodes(codeType, true);
                            showMessage('uploadMessage', 'üîÑ Memuat ulang kode...', 'success');
                        }, 5000);
                    } else {
                        loadCodes(codeType, true);
                    }
                }
                
                // Update stats
                updateStats();
                
            } catch (error) {
                console.error('Upload error:', error);
                showMessage('uploadMessage', `‚ùå Upload gagal: ${error.message}`, 'error');
            }
        }

        // Helper function untuk membaca file
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }

        // Inisialisasi
        document.addEventListener('DOMContentLoaded', () => {
            // Load kode default
            loadCodes('esm');
            
            // Update timer setiap detik
            setInterval(updateRefreshTimer, 1000);
            
            // Update stats setiap 30 detik
            setInterval(updateStats, 30000);
            
            // Event listener untuk tombol ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (codeDisplay.style.display === 'block') {
                        closeCodeDisplay();
                    } else if (requestModal.style.display === 'block') {
                        closeRequestModal();
                    } else if (adminPanel.style.display === 'block') {
                        closeAdminPanel();
                    }
                }
            });

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    if (requestModal.style.display === 'block') {
                        closeRequestModal();
                    } else if (adminPanel.style.display === 'block') {
                        closeAdminPanel();
                    }
                }
            });
        });
    </script>
</body>
</html>